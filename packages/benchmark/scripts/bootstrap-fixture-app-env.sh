#!/usr/bin/env bash
set -euo pipefail

REPO="${GHX_REPO:-aryeko/ghx}"
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"
OUT_FILE="${ROOT_DIR}/.env.local"

read_repo_var() {
  local name="$1"
  gh variable get "$name" --repo "$REPO" 2>/dev/null || true
}

APP_ID="${BENCH_FIXTURE_GH_APP_ID:-$(read_repo_var BENCH_FIXTURE_GH_APP_ID)}"
INSTALL_ID="${BENCH_FIXTURE_GH_APP_INSTALLATION_ID:-$(read_repo_var BENCH_FIXTURE_GH_APP_INSTALLATION_ID)}"
KEY_PATH="${BENCH_FIXTURE_GH_APP_PRIVATE_KEY_PATH:-}"
KEY_INLINE="${BENCH_FIXTURE_GH_APP_PRIVATE_KEY:-}"

if [[ -z "$APP_ID" || -z "$INSTALL_ID" ]]; then
  echo "Missing app IDs. Set env vars or repo variables for BENCH_FIXTURE_GH_APP_ID and BENCH_FIXTURE_GH_APP_INSTALLATION_ID." >&2
  exit 1
fi

{
  echo "# Generated by packages/benchmark/scripts/bootstrap-fixture-app-env.sh"
  echo "BENCH_FIXTURE_GH_APP_ID=${APP_ID}"
  echo "BENCH_FIXTURE_GH_APP_INSTALLATION_ID=${INSTALL_ID}"

  if [[ -n "$KEY_INLINE" ]]; then
    ESCAPED_KEY="$(printf "%s" "$KEY_INLINE" | awk 'BEGIN{ORS=""} {gsub(/\\/,"\\\\"); gsub(/"/,"\\\""); printf "%s\\n",$0}')"
    echo "BENCH_FIXTURE_GH_APP_PRIVATE_KEY=\"${ESCAPED_KEY}\""
  elif [[ -n "$KEY_PATH" ]]; then
    echo "BENCH_FIXTURE_GH_APP_PRIVATE_KEY_PATH=${KEY_PATH}"
  else
    echo "Missing private key source. Set BENCH_FIXTURE_GH_APP_PRIVATE_KEY or BENCH_FIXTURE_GH_APP_PRIVATE_KEY_PATH." >&2
    echo "Note: GitHub Actions secret values are write-only and cannot be retrieved via API/CLI." >&2
    exit 1
  fi
} >"$OUT_FILE"

echo "Wrote ${OUT_FILE}"
